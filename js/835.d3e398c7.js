"use strict";(globalThis["webpackChunklmschat_mobile"]=globalThis["webpackChunklmschat_mobile"]||[]).push([[835],{6835:(e,t,a)=>{a.r(t),a.d(t,{default:()=>we});var s=a(9835),o=a(6970),r=a(1957);const l=(0,s._)("span",null,"Настройки",-1);function n(e,t,a,n,i,m){const u=(0,s.up)("PlatformPage"),d=(0,s.up)("q-tab-panel"),c=(0,s.up)("SettingsPage"),p=(0,s.up)("q-tab-panels"),h=(0,s.up)("q-icon"),g=(0,s.up)("q-tab"),f=(0,s.up)("q-tabs"),w=(0,s.up)("q-page");return(0,s.wg)(),(0,s.j4)(w,{class:"main_page-wrapper flex column justify-between"},{default:(0,s.w5)((()=>[(0,s.Wm)(p,{class:"main_page-tab_panels",modelValue:e.tab,"onUpdate:modelValue":t[0]||(t[0]=t=>e.tab=t),animated:""},{default:(0,s.w5)((()=>[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(e.platformsList,(e=>((0,s.wg)(),(0,s.j4)(d,{key:e.name,name:e.name,class:"q-px-none"},{default:(0,s.w5)((()=>[(0,s.Wm)(u,{platform:e,modelValue:e.isUserAuth,"onUpdate:modelValue":t=>e.isUserAuth=t},null,8,["platform","modelValue","onUpdate:modelValue"])])),_:2},1032,["name"])))),128)),(0,s.Wm)(d,{name:"settings",key:"settings",class:"q-px-none"},{default:(0,s.w5)((()=>[(0,s.Wm)(c,{"platforms-list":e.platformsList},null,8,["platforms-list"])])),_:1})])),_:1},8,["modelValue"]),(0,s.Wm)(f,{modelValue:e.tab,"onUpdate:modelValue":t[1]||(t[1]=t=>e.tab=t),dense:"","active-class":"nav_menu__tabs-active",align:"justify","narrow-indicator":"",class:"nav_menu__tabs",style:{"font-size":"12px"}},{default:(0,s.w5)((()=>[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(e.platformsList,((e,t)=>(0,s.wy)(((0,s.wg)(),(0,s.j4)(g,{key:t,name:e.name,"no-caps":""},{default:(0,s.w5)((()=>[(0,s.Wm)(h,{name:"school",size:"20px",style:{"margin-bottom":"6px"}}),(0,s._)("span",null,(0,o.zw)(e.label),1)])),_:2},1032,["name"])),[[r.F8,e.showTab]]))),128)),(0,s.Wm)(g,{name:"settings","no-caps":""},{default:(0,s.w5)((()=>[(0,s.Wm)(h,{name:"settings",size:"20px",style:{"margin-bottom":"6px"}}),l])),_:1})])),_:1},8,["modelValue"])])),_:1})}var i=a(499);const m=e=>((0,s.dD)("data-v-88c05a3c"),e=e(),(0,s.Cn)(),e),u={class:"settings__page"},d=m((()=>(0,s._)("div",{class:"settings__title"},"Настройки",-1))),c={class:"settings__rows-wrapper q-pa-md flex column"},p={class:"setting__rows"};function h(e,t,a,o,r,l){const n=(0,s.up)("q-separator"),i=(0,s.up)("ToggleRow");return(0,s.wg)(),(0,s.iD)("div",u,[d,(0,s.Wm)(n),(0,s._)("div",c,[(0,s._)("div",p,[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(a.platformsList,((e,t)=>((0,s.wg)(),(0,s.j4)(i,{key:t,modelValue:e.showTab,"onUpdate:modelValue":t=>e.showTab=t,userAuth:e.isUserAuth,"onUpdate:userAuth":t=>e.isUserAuth=t,"platform-label":e.label,"platform-name":e.name,isLastRow:t===a.platformsList.length-1},null,8,["modelValue","onUpdate:modelValue","userAuth","onUpdate:userAuth","platform-label","platform-name","isLastRow"])))),128))])])])}const g={class:"toggle_row__wrapper"},f={class:"row justify-between items-center q-pa-sm"},w=(0,s._)("span",null,"Выйти",-1);function b(e,t,a,l,n,i){const m=(0,s.up)("q-toggle"),u=(0,s.up)("q-icon"),d=(0,s.up)("q-separator");return(0,s.wg)(),(0,s.iD)("div",g,[(0,s._)("div",f,[(0,s._)("span",null,(0,o.zw)(a.platformLabel),1),(0,s.Wm)(m,{class:"toggle_row__toggle","model-value":a.modelValue,"onUpdate:modelValue":i.onUpdate},null,8,["model-value","onUpdate:modelValue"])]),(0,s.wy)((0,s._)("div",{class:"toggle_row__logout row justify-between items-center q-pa-sm",onClick:t[0]||(t[0]=(...e)=>i.logout&&i.logout(...e))},[w,(0,s.Wm)(u,{name:"logout",class:"toggle_row__logout_button"})],512),[[r.F8,a.userAuth]]),(0,s.wy)((0,s.Wm)(d,null,null,512),[[r.F8,!a.isLastRow]])])}const _={name:"ToggleRow",props:{modelValue:{type:[String,Boolean],default:""},userAuth:{type:[String,Boolean],default:""},platformLabel:{required:!0,type:String},platformName:{required:!0,type:String},isLastRow:{required:!1,type:Boolean}},emits:["update:modelValue","update:userAuth"],computed:{isUserAuth(){return!0}},methods:{onUpdate(e){this.$emit("update:modelValue",e),localStorage.setItem(`${this.platformName}TabIsShow`,e)},logout(){this.$emit("update:userAuth",!1),localStorage.setItem(`${this.platformName}Operator`,"")}}};var y=a(1639),I=a(592),S=a(2857),v=a(926),T=a(9984),U=a.n(T);const q=(0,y.Z)(_,[["render",b]]),$=q;U()(_,"components",{QToggle:I.Z,QIcon:S.Z,QSeparator:v.Z});const V={name:"SettingsPage",props:{platformsList:{type:Array}},components:{ToggleRow:$}},A=(0,y.Z)(V,[["render",h],["__scopeId","data-v-88c05a3c"]]),C=A;U()(V,"components",{QSeparator:v.Z});const L={class:"platform_page"},Z={key:0,class:"absolute-full"},k=["src"],N=["src"];function W(e,t,a,l,n,i){const m=(0,s.up)("q-badge"),u=(0,s.up)("q-tab"),d=(0,s.up)("q-tabs"),c=(0,s.up)("q-separator"),p=(0,s.up)("AuthPage");return(0,s.wg)(),(0,s.iD)("div",L,[a.platform.isUserAuth?((0,s.wg)(),(0,s.iD)("div",Z,[(0,s.wy)((0,s._)("div",null,[(0,s.Wm)(d,{modelValue:l.chatTab,"onUpdate:modelValue":t[0]||(t[0]=e=>l.chatTab=e),"inline-label":"","no-caps":"",class:"platform_page__tabs","active-class":"nav_menu__tabs-active"},{default:(0,s.w5)((()=>[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(l.chats,(e=>((0,s.wg)(),(0,s.j4)(u,{key:e.id,name:e.chatName,label:e.chatName,onClick:t=>l.currentChatId=e.id},{default:(0,s.w5)((()=>[+e.newDialogsCount>0?((0,s.wg)(),(0,s.j4)(m,{key:0,class:"platform_page__tabs-badge q-ml-sm flex-center",label:e.newDialogsCount,style:{"background-color":"#14C850"},rounded:""},null,8,["label"])):(0,s.kq)("",!0)])),_:2},1032,["name","label","onClick"])))),128))])),_:1},8,["modelValue"]),(0,s.Wm)(c)],512),[[r.F8,l.showChatsTabs]]),(0,s._)("iframe",{ref:"frame",src:i.chatUrl,width:"100%",height:"100%",class:(0,o.C_)(["no-border",{"short-frame":l.showChatsTabs}]),allow:"microphone; clipboard-read; clipboard-write",onLoad:t[1]||(t[1]=(...e)=>i.frameLoaded&&i.frameLoaded(...e))},null,42,k),l.showUserDialog?((0,s.wg)(),(0,s.iD)("iframe",{key:0,src:i.getUserDialogUrl,width:"100%",height:"100%",class:(0,o.C_)(["no-border absolute-full",{"short-frame":l.showChatsTabs}]),allow:"microphone; clipboard-read; clipboard-write",onLoad:t[2]||(t[2]=(...e)=>i.frameLoaded&&i.frameLoaded(...e))},null,42,N)):(0,s.kq)("",!0)])):((0,s.wg)(),(0,s.j4)(p,{key:1,onAuthOperator:i.authOperator,"platform-name":a.platform.name},null,8,["onAuthOperator","platform-name"]))])}var D=a(9981),O=a.n(D),Q=a(5717);const R=e=>((0,s.dD)("data-v-1c5888f9"),e=e(),(0,s.Cn)(),e),H={class:"auth_page text-center"},P=R((()=>(0,s._)("div",{class:"auth_page-title"},"Авторизация",-1)));function x(e,t,a,o,l,n){const i=(0,s.up)("q-input"),m=(0,s.up)("q-btn"),u=(0,s.up)("q-form");return(0,s.wg)(),(0,s.iD)("div",H,[P,(0,s.Wm)(u,{class:"flex column",onSubmit:(0,r.iM)(n.enter,["prevent"])},{default:(0,s.w5)((()=>[(0,s.Wm)(i,{modelValue:o.email,"onUpdate:modelValue":t[0]||(t[0]=e=>o.email=e),outlined:"",label:"Введите E-mail",class:"auth_page__input q-mb-lg"},null,8,["modelValue"]),(0,s.Wm)(i,{modelValue:o.password,"onUpdate:modelValue":t[1]||(t[1]=e=>o.password=e),outlined:"",label:"Введите пароль",class:"auth_page__input q-mb-lg",type:"password"},null,8,["modelValue"]),(0,s.Wm)(m,{label:"Войти",type:"submit",class:"auth_page__button"})])),_:1},8,["onSubmit"])])}var B=a(1809);const j=(0,B.Q_)("counter",{state:()=>({currentTab:""}),getters:{},actions:{setCurrentTab(e){this.currentTab=e}}}),F=j();class z{constructor(){this.loaded=!1,this.accessRows=[],this.accessRowsByTags=[],this.isSuperadmin=!1,this.operatorId=void 0,this.logout=void 0,this.operator=void 0}async load(){const{currentTab:e}=F;localStorage.removeItem(`${e}-operator-hashtags`);const t=localStorage.getItem(`${e}OperatorId`);let a=!1;if(t?await(0,Q.queryBot)(`select isSuperadmin, tags, workingHours from operators where id = '${t}'`,e).then((t=>{const[s]=t.data;if(this.operator=s,s){let t=1;const{isSuperadmin:a}=s;t="1"===a?3:1,localStorage.setItem(`${e}-is-admin-logged`,t),localStorage.setItem(`${e}-operator-hashtags`,s.tags)}else a=!0})):a=!0,a)return;const s=localStorage.getItem(`${e}-is-admin-logged`);this.operatorId=localStorage.getItem(`${e}OperatorId`),3!==+s?(s&&(this.isSuperadmin="1"===localStorage.getItem(`${e}IsSuperadmin`),await(0,Q.queryBot)(`select * from operators_access where operatorId = '${this.operatorId}'`,e).then((e=>{this.accessRows=e.data})),await(0,Q.queryBot)("select * from operators_access where operatorId is null",e).then((e=>{this.accessRowsByTags=e.data}))),this.loaded=!0):this.isSuperadmin=!0}}const M=new z,K={None:0,Read:1,Modify:2,Add:3,Remove:4,Access:5},Y=(K.None,K.Read,K.Modify,K.Add,K.Remove,K.Access,a(9315)),J={name:"AuthPage",setup(){return{email:(0,i.iH)(""),password:(0,i.iH)("")}},props:{platformName:{type:String}},emits:["operator-auth"],methods:{enter(){const{email:e}=this;let{password:t}=this;t=Y(t),t=`%${t}`,(0,Q.login)(e,t,this.platformName).then((async e=>{let{level:t}=e.data;if(t=+t,!t)return this.$q.notify("Неправильный логин или пароль"),void(this.password="");const{operator:a}=e.data,{id:s}=a,{name:o}=a,{nickname:r}=a,{isSuperadmin:l}=a;t="1"===l?3:1,localStorage.setItem(`${this.platformName}Operator`,JSON.stringify(a)),localStorage.setItem(`${this.platformName}-is-admin-logged`,t),localStorage.setItem(`${this.platformName}IsSuperadmin`,l),localStorage.setItem(`${this.platformName}OperatorName`,o),localStorage.setItem(`${this.platformName}OperatorNickname`,r),localStorage.setItem(`${this.platformName}OperatorId`,s),this.$emit("auth-operator",a),await M.load()}))}}};var E=a(8326),G=a(7471),X=a(4095);const ee=(0,y.Z)(J,[["render",x],["__scopeId","data-v-1c5888f9"]]),te=ee;U()(J,"components",{QForm:E.Z,QInput:G.Z,QBtn:X.Z});a(9315);function ae(e,t){if(!e)return!1;if(!t)return!1;const a=t.split("#").map((e=>e.trim())),s=e.split("#").map((e=>e.trim())),o=a.filter((e=>s.includes(e))).filter((e=>e));return o.length>0}const se=j(),oe={methods:{hasAccess(e,t,a=0){const{currentTab:s}=se;if(0===a)return!1;if(!M)return console.log("No access info loaded!"),!1;if(M.isSuperadmin)return!0;if(!M.operatorId)return!0;if(!M.loaded)return!1;const{accessRows:o}=M,[r]=o.filter((a=>a.pageType===e&&+a.pageId===+t));if(!r){const o=localStorage.getItem(`${s}-operator-hashtags`),{accessRowsByTags:r}=M,l=r.filter((a=>a.pageType===e&&+a.pageId===+t));for(let e=0;e<l.length;e+=1){const{tag:t}=l[e];if(ae(o,t))return+l[e].accessLevel>=+a}return!1}return+r.accessLevel>=+a},isSuperadmin(){const{currentTab:e}=se;return"3"===localStorage.getItem(`${e}-is-admin-logged`)||M.isSuperadmin}}},re=oe,le={name:"PlatformPage",components:{AuthPage:te},setup(){return{operator:(0,i.iH)(null),chats:(0,i.iH)(null),chatTab:(0,i.iH)(null),currentChatId:(0,i.iH)(null),showChatsTabs:(0,i.iH)(!0),showUserDialog:(0,i.iH)(!1),siteUserId:(0,i.iH)(null)}},props:{modelValue:{type:[String,Boolean],default:""},platform:{required:!0,type:Object}},emits:["update:modelValue"],mixins:[re],computed:{chatUrl(){const{name:e}=this.platform,{currentChatId:t}=this||"1";let{operator:a}=this;return a||(a=JSON.parse(localStorage.getItem(`${e}Operator`))),this.chats||this.loadChats(a.id),`https://client.lmschat.1t.ru/operator/${a.id}?chat=${t}&mode=${e}`},getUserDialogUrl(){return`https://${this.platform.name}.1t.ru/bd0f-d569/user-dialog?siteUserId=${this.siteUserId}`}},mounted(){this.init()},methods:{async init(){await M.load()},authOperator(e){this.operator=e,this.$emit("update:modelValue",!this.platform.isUserAuth)},loadChats(e){O().get(`https://${this.platform.name}.lmschat.1t.ru/chats`,{headers:{Authorization:`o:${e}:lms`}}).then((e=>{const{data:t}=e;this.chats=t.filter((e=>this.hasAccess("chat",e.id,K.Read))),this.currentChatId=this.chats[0].id,this.chatTab=this.chats[0].chatName}))},async frameLoaded(){try{const e=this.$refs.frame,{contentWindow:t}=e;this.$q.chatContentWindow=t,window.addEventListener("message",this.onFrameMessage)}catch(e){console.log(e)}},async onFrameMessage(e){const{data:t}=e;if(!t)return;if("string"!==typeof t)return;if(!t.includes("{"))return;if(t.startsWith("__"))return;const a=JSON.parse(t),{action:s}=a;if("open-room"===s)this.showChatsTabs=!1;else if("hide-room"===s)this.showChatsTabs=!0;else if("hide-user-dialog"===s)this.showUserDialog=!1;else if("room-name"===s){const{room:e}=a;if(!e)return;const{owner:t}=e,{siteUserId:s}=t;let o;const r=`select *\n                     from users\n                     where id = ${s}`;if(await(0,Q.queryBot)(r,this.platform.name).then((e=>{[o]=e.data})),o){const{id:e}=o;e&&(this.siteUserId=e,this.showUserDialog=!0)}}}}};var ne=a(2354),ie=a(900),me=a(990);const ue=(0,y.Z)(le,[["render",W],["__scopeId","data-v-587fb072"]]),de=ue;U()(le,"components",{QTabs:ne.Z,QTab:ie.Z,QBadge:me.Z,QSeparator:v.Z});const ce=(0,s.aZ)({name:"IndexPage",components:{SettingsPage:C,PlatformPage:de},setup(){const e=j();return{tab:(0,i.iH)("settings"),platformsList:(0,i.iH)([{name:"start",label:"Старт",showTab:"true"===localStorage.getItem("startTabIsShow"),isUserAuth:localStorage.getItem("startOperator")},{name:"data",label:"Дата",showTab:"true"===localStorage.getItem("dataTabIsShow"),isUserAuth:localStorage.getItem("dataOperator")}]),store:e}},mounted(){this.init()},watch:{tab(e){this.store.setCurrentTab(e)}},methods:{async init(){this.getCurrentTab()},getCurrentTab(){const e=this.platformsList.find((e=>!0===e.showTab));e&&(this.tab=e.name,this.store.setCurrentTab(this.tab))}}});var pe=a(9885),he=a(9800),ge=a(4106);const fe=(0,y.Z)(ce,[["render",n]]),we=fe;U()(ce,"components",{QPage:pe.Z,QTabPanels:he.Z,QTabPanel:ge.Z,QTabs:ne.Z,QTab:ie.Z,QIcon:S.Z})}}]);